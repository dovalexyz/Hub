<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DuValle Deluxe | Control Center</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Rajdhani:wght@300;500;700&family=Poppins:wght@300;400;600&display=swap');

        :root {
            --primary: #ff0040; /* Vermelho Carmesim Luxuoso */
            --primary-dim: rgba(255, 0, 64, 0.2);
            --bg-dark: #030305;
            --glass-panel: rgba(15, 15, 20, 0.7);
            --border: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-muted: #888;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; scrollbar-width: thin; scrollbar-color: var(--primary) #111; }
        
        /* Scrollbar Customizada */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 3px; }

        body {
            min-height: 100vh;
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255, 0, 64, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(100, 0, 255, 0.05) 0%, transparent 40%);
            font-family: 'Poppins', sans-serif;
            display: flex;
            overflow: hidden;
            color: var(--text-main);
        }

        /* --- BACKGROUND MESH (Grid Futurista) --- */
        .grid-bg {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-image: linear-gradient(var(--border) 1px, transparent 1px),
            linear-gradient(90deg, var(--border) 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.1;
            transform: perspective(500px) rotateX(60deg) translateY(-100px) translateZ(-200px);
            animation: gridMove 20s linear infinite;
            z-index: -1;
            pointer-events: none;
        }

        @keyframes gridMove { from { background-position: 0 0; } to { background-position: 0 1000px; } }

        /* --- SIDEBAR DE LUXO --- */
        .sidebar {
            width: 320px;
            background: rgba(5, 5, 8, 0.95);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
            padding: 40px 30px;
            z-index: 10;
            backdrop-filter: blur(20px);
            box-shadow: 10px 0 50px rgba(0,0,0,0.5);
        }

        .brand-container {
            margin-bottom: 50px;
            text-align: center;
            position: relative;
        }

        .brand-logo {
            font-family: 'Cinzel', serif; /* Fonte ClÃ¡ssica/Luxuosa */
            font-size: 32px;
            font-weight: 700;
            color: #fff;
            letter-spacing: 2px;
            text-shadow: 0 0 20px var(--primary);
            margin-bottom: 5px;
            background: linear-gradient(to bottom, #fff, #bbb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .brand-subtitle {
            font-family: 'Rajdhani', sans-serif;
            font-size: 12px;
            color: var(--primary);
            letter-spacing: 6px;
            text-transform: uppercase;
            font-weight: 700;
        }

        .section-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 5px;
        }

        .file-list {
            flex: 1; overflow-y: auto;
            display: flex; flex-direction: column; gap: 10px;
        }

        /* ITEMS DA LISTA (BotÃµes de Arquivo) */
        .file-item {
            padding: 15px 20px;
            border-radius: 8px;
            background: rgba(255,255,255,0.02);
            border: 1px solid transparent;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            display: flex; align-items: center; justify-content: space-between;
            position: relative;
            overflow: hidden;
        }

        .file-item::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px;
            background: var(--primary); transform: scaleY(0); transition: 0.3s;
        }

        .file-item:hover {
            background: linear-gradient(90deg, var(--primary-dim), transparent);
            color: #fff;
            padding-left: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border-color: rgba(255,0,64,0.3);
        }

        .file-item.active {
            background: linear-gradient(90deg, var(--primary), transparent);
            color: #fff;
            border-color: var(--primary);
            font-weight: 600;
        }
        
        .file-icon { font-size: 16px; margin-right: 10px; opacity: 0.5; }

        /* USER PROFILE FOOTER */
        .user-footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
        }
        
        .user-info { font-size: 12px; color: var(--text-muted); }
        .user-info span { display: block; color: #fff; font-weight: 600; font-family: 'Rajdhani'; font-size: 14px; }

        .btn-logout {
            background: transparent; border: 1px solid var(--border); color: var(--text-muted);
            width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s; font-size: 12px;
        }
        .btn-logout:hover { border-color: var(--primary); color: var(--primary); box-shadow: 0 0 10px var(--primary); }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1; padding: 60px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            position: relative;
        }

        /* Efeito de Vignette (Bordas escuras) */
        .main-content::after {
            content: ''; position: absolute; inset: 0;
            background: radial-gradient(circle at center, transparent 50%, #000 100%);
            pointer-events: none;
        }

        /* EDITOR CARD */
        .editor-container {
            width: 100%; max-width: 700px;
            background: rgba(10, 10, 15, 0.6);
            backdrop-filter: blur(30px);
            border: 1px solid var(--border);
            border-top: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 50px;
            box-shadow: 0 20px 80px rgba(0,0,0,0.6);
            display: none; opacity: 0; transform: translateY(20px);
            transition: 0.5s;
            position: relative; z-index: 5;
        }
        .editor-container.visible { display: block; opacity: 1; transform: translateY(0); }

        .editor-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid var(--border);
        }
        
        .editor-header h2 {
            font-family: 'Rajdhani', sans-serif; font-size: 24px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 2px;
            display: flex; align-items: center; gap: 10px;
        }
        .target-badge {
            font-size: 12px; background: var(--primary-dim); color: var(--primary);
            padding: 4px 10px; border-radius: 4px; border: 1px solid var(--primary);
        }

        /* INPUTS ESTILO HUD */
        .input-group { margin-bottom: 25px; position: relative; }
        
        .input-group label {
            display: block; font-family: 'Rajdhani'; font-size: 12px; color: var(--text-muted);
            margin-bottom: 8px; letter-spacing: 1px; text-transform: uppercase; font-weight: 700;
        }

        .input-group input, .input-group textarea {
            width: 100%;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            border-left: 2px solid var(--border);
            padding: 15px;
            color: #fff;
            font-family: 'Poppins', sans-serif; font-size: 14px;
            border-radius: 0 8px 8px 0;
            transition: 0.3s;
        }

        .input-group input:focus, .input-group textarea:focus {
            outline: none;
            background: rgba(255, 0, 64, 0.05);
            border-color: var(--primary);
            border-left-width: 4px;
            box-shadow: 0 0 20px rgba(255, 0, 64, 0.1);
        }

        /* BOTÃƒO DE AÃ‡ÃƒO */
        .btn-action {
            width: 100%;
            padding: 18px;
            background: linear-gradient(90deg, var(--primary), #aa002a);
            color: #fff;
            border: none;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            font-size: 16px;
            letter-spacing: 4px;
            text-transform: uppercase;
            cursor: pointer;
            clip-path: polygon(0 0, 100% 0, 100% 85%, 95% 100%, 0 100%); /* Corte Sci-Fi */
            transition: 0.3s;
            position: relative; overflow: hidden;
        }

        .btn-action:hover {
            box-shadow: 0 0 30px var(--primary);
            letter-spacing: 6px;
        }
        
        .btn-action:disabled { background: #333; cursor: not-allowed; box-shadow: none; }

        /* LOADING & NOTIFICATIONS */
        .loader-overlay {
            position: fixed; inset: 0; background: #000; z-index: 999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            font-family: 'Rajdhani'; color: var(--primary); letter-spacing: 3px;
        }
        .loader-overlay.hidden { opacity: 0; pointer-events: none; transition: 0.5s; }

        .toast {
            position: fixed; bottom: 30px; right: 30px;
            background: rgba(10, 10, 15, 0.9); border: 1px solid var(--primary);
            padding: 15px 25px; color: #fff; border-radius: 4px;
            display: flex; align-items: center; gap: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transform: translateX(200%); transition: 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            z-index: 100;
        }
        .toast.show { transform: translateX(0); }
        .toast-icon { font-size: 20px; }

        /* Placeholder Inicial */
        .placeholder-text {
            text-align: center; color: rgba(255,255,255,0.2);
            font-family: 'Rajdhani'; text-transform: uppercase; letter-spacing: 2px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 0.2; } 50% { opacity: 0.5; } }

    </style>
</head>
<body>

    <div class="loader-overlay" id="loadingScreen">
        <div style="font-size: 40px; margin-bottom: 20px;">DUVALLE DELUXE</div>
        <div style="font-size: 14px; opacity: 0.7;">INITIALIZING SYSTEM PROTOCOLS...</div>
    </div>

    <div class="toast" id="toastMsg">
        <div class="toast-icon" id="toastIcon">âœ…</div>
        <div id="toastText">Operation Successful</div>
    </div>

    <div class="grid-bg"></div>

    <div class="sidebar">
        <div class="brand-container">
            <div class="brand-logo">DUVALLE</div>
            <div class="brand-subtitle">DELUXE // SYSTEM</div>
        </div>

        <div class="section-title">Project Modules</div>
        <div class="file-list" id="fileList">
            </div>

        <div class="user-footer">
            <div class="user-info">
                Logged in as:
                <span id="adminEmail">...</span>
            </div>
            <button class="btn-logout" onclick="logout()" title="Disconnect">âœ•</button>
        </div>
    </div>

    <div class="main-content">
        <div class="placeholder-text" id="placeholderMsg">
            Select a module from the sidebar<br>to begin configuration
        </div>

        <div class="editor-container" id="editorPanel">
            <div class="editor-header">
                <h2>Configuration <span style="font-size:12px; margin-left:10px; color:#555">// EDIT MODE</span></h2>
                <span class="target-badge" id="targetFile">...</span>
            </div>
            
            <div class="input-group">
                <label>Display Name</label>
                <input type="text" id="metaTitle" placeholder="Ex: Login System">
            </div>

            <div class="input-group">
                <label>Visual Icon (Emoji)</label>
                <input type="text" id="metaIcon" placeholder="Ex: âš¡">
            </div>

            <div class="input-group">
                <label>System Description</label>
                <textarea id="metaDesc" rows="4" placeholder="Brief description of the project functionality..."></textarea>
            </div>

            <button class="btn-action" onclick="saveChanges()" id="saveBtn">UPDATE REPOSITORY</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // CONFIGURAÃ‡ÃƒO FIREBASE
        const firebaseConfig = {
          apiKey: "AIzaSyCcvCjQmGCU-8XIalj7lCl-EshgKbBwT-w",
          authDomain: "hub-admin-dovale.firebaseapp.com",
          projectId: "hub-admin-dovale",
          storageBucket: "hub-admin-dovale.firebasestorage.app",
          messagingSenderId: "520570250135",
          appId: "1:520570250135:web:d65ba618c0260ddf8d1ad2",
          measurementId: "G-QWFSK5J1S8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // CONFIG GITHUB
        const GITHUB_USER = 'dovalexyz';
        const GITHUB_REPO = 'PacksHTMLCSSJS';
        let GITHUB_TOKEN = null;

        let currentFiles = [];
        let currentMetadata = [];
        let selectedFile = null;
        let metadataSha = null;

        // UTILS
        function utf8_to_b64(str) { return window.btoa(unescape(encodeURIComponent(str))); }
        function b64_to_utf8(str) { return decodeURIComponent(escape(window.atob(str))); }
        
        function showToast(msg, type='success') {
            const toast = document.getElementById('toastMsg');
            document.getElementById('toastText').innerText = msg;
            document.getElementById('toastIcon').innerText = type === 'success' ? 'âœ…' : 'âš ï¸';
            toast.style.borderColor = type === 'success' ? '#00ff88' : '#ff0040';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 4000);
        }

        // AUTH
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('adminEmail').innerText = user.email.split('@')[0]; // Mostra sÃ³ o nome antes do @
                await retrieveToken();
            } else {
                window.location.href = "admin.html";
            }
        });

        async function retrieveToken() {
            try {
                const docRef = doc(db, "system", "secrets");
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    GITHUB_TOKEN = docSnap.data().github_token.trim();
                    document.getElementById('loadingScreen').classList.add('hidden');
                    initSystem();
                } else {
                    alert("FATAL: Token not found in DB.");
                }
            } catch (error) {
                console.error(error);
                alert("Database Error.");
            }
        }

        async function initSystem() {
            await fetchFiles();
            await fetchMetadata();
            renderList();
        }

        async function fetchFiles() {
            try {
                const res = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents`, {
                    headers: { 'Authorization': `Bearer ${GITHUB_TOKEN}` }
                });
                const data = await res.json();
                currentFiles = data.filter(f => f.name.endsWith('.html'));
            } catch (e) { showToast("Error connecting to GitHub", "error"); }
        }

        async function fetchMetadata() {
            try {
                const res = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/projects.json`, {
                    headers: { 'Authorization': `Bearer ${GITHUB_TOKEN}` }
                });
                if(res.ok) {
                    const data = await res.json();
                    metadataSha = data.sha;
                    try {
                        currentMetadata = JSON.parse(b64_to_utf8(data.content));
                    } catch(err) {
                        currentMetadata = JSON.parse(atob(data.content));
                    }
                }
            } catch(e) { console.log('Metadata init...'); }
        }

        function renderList() {
            const list = document.getElementById('fileList');
            list.innerHTML = '';
            currentFiles.forEach(file => {
                const div = document.createElement('div');
                div.className = 'file-item';
                div.innerHTML = `<span style="display:flex; align-items:center"><span class="file-icon">ðŸ“„</span> ${file.name}</span>`;
                div.onclick = () => selectFile(file.name, div);
                list.appendChild(div);
            });
        }

        window.selectFile = function(filename, element) {
            document.querySelectorAll('.file-item').forEach(d => d.classList.remove('active'));
            element.classList.add('active');
            
            document.getElementById('placeholderMsg').style.display = 'none';
            document.getElementById('editorPanel').classList.add('visible');
            
            selectedFile = filename;
            document.getElementById('targetFile').innerText = filename;

            const meta = currentMetadata.find(m => m.filename === filename) || {};
            document.getElementById('metaTitle').value = meta.title || filename.replace('.html', '');
            document.getElementById('metaIcon').value = meta.icon || 'âš¡';
            document.getElementById('metaDesc').value = meta.description || '';
        }

        window.saveChanges = async function() {
            const btn = document.getElementById('saveBtn');
            const originalText = btn.innerText;
            btn.innerText = 'SYNCING TO SATELLITE...';
            btn.disabled = true;

            try {
                const newMeta = {
                    filename: selectedFile,
                    title: document.getElementById('metaTitle').value,
                    icon: document.getElementById('metaIcon').value,
                    description: document.getElementById('metaDesc').value
                };

                currentMetadata = currentMetadata.filter(m => m.filename !== selectedFile);
                currentMetadata.push(newMeta);

                const content = utf8_to_b64(JSON.stringify(currentMetadata, null, 2));
                const body = { 
                    message: `DuValle Deluxe Update: ${selectedFile}`, 
                    content: content
                };
                if (metadataSha) body.sha = metadataSha;

                const res = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/projects.json`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${GITHUB_TOKEN}`, 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify(body)
                });

                if(res.ok) {
                    const data = await res.json();
                    metadataSha = data.content.sha;
                    showToast("System Updated Successfully!");
                } else {
                    const err = await res.json();
                    showToast(`Error: ${err.message}`, "error");
                }
            } catch(e) { 
                showToast("Network Error", "error");
            }
            
            btn.innerText = originalText;
            btn.disabled = false;
        }

        window.logout = function() {
            signOut(auth).then(() => window.location.href = "admin.html");
        }
    </script>
</body>
</html>